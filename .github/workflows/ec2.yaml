name: Deploy FastAPI to EC2

on:
  push:
    branches:
      - main
      - develop

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.AI_SERVER_EC2_HOST }}
        username: ${{ secrets.AI_SERVER_EC2_USERNAME }}
        key: ${{ secrets.AI_SERVER_EC2_SSH_KEY }}
        script: |


            # --- ë³€ìˆ˜ ì„¤ì • ë° ì´ˆê¸°í™” ---
            BRANCH_NAME="${{ github.ref_name }}"
            HOME_DIR="/home/${{ secrets.AI_SERVER_EC2_USERNAME }}"
            PROJECT_DIR="${HOME_DIR}/SW-project"
            SERVICE_NAME="fastapi-app.service" # systemd ì„œë¹„ìŠ¤ ì´ë¦„

            echo "í˜„ì¬ ë°°í¬ ë¸Œëœì¹˜: ${BRANCH_NAME}"
            echo "ì‘ì—… ì‹œì‘: $(date)"

           

            # Git ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜ (Amazon Linuxìš©)
            if ! command -v git &> /dev/null; then
                echo "gitì´ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¤ì¹˜ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤..."
                sudo yum update -y # íŒ¨í‚¤ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸ (Amazon Linux)
                sudo yum install git -y # git ì„¤ì¹˜ (Amazon Linux)
                echo "git ì„¤ì¹˜ ì™„ë£Œ."
            else
                echo "gitì´ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
            fi
                
            # --- Git í”„ë¡œì íŠ¸ í´ë¡ /í’€ ---
            if [ ! -d "$PROJECT_DIR" ]; then
                echo "ğŸ“ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•˜ê³  ë¦¬í¬ì§€í† ë¦¬ë¥¼ cloneí•©ë‹ˆë‹¤..."
                git clone https://github.com/kanggihoo/SW-project.git
                git pull origin ${BRANCH_NAME}
            else
                echo "ğŸ“ ê¸°ì¡´ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤..."
                echo "git pull origin ${BRANCH_NAME} ì‹¤í–‰ ì¤‘..."
                git pull origin ${BRANCH_NAME}
            fi
            echo "ì €ì¥ì†Œ í´ë¡ /pull ì™„ë£Œ."

            # echo "ğŸ”„ ê¸°ì¡´ ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤..."
            # # í¬íŠ¸ ê¸°ë°˜ ì •ë¦¬ (ì•ˆì „í•¨)
            # echo "í¬íŠ¸ 8000 ì •ë¦¬ ì¤‘..."
            # lsof -ti:8000 | xargs -r kill -TERM 2>/dev/null || true
            # sleep 3

            # --- uv ì„¤ì¹˜ ë° Python ê°€ìƒí™˜ê²½ ì„¤ì • ---
            if ! command -v uv &> /dev/null; then
                echo "uvê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¤ì¹˜ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤..."
                curl -LsSf https://astral.sh/uv/install.sh | sh
                export PATH="$HOME/.local/bin:$PATH"
                echo "uv ì„¤ì¹˜ ë° PATH ì„¤ì • ì™„ë£Œ."
            else
                echo "uvê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
            fi
            
            cd $PROJECT_DIR # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ í™•ì¸
            # Python ê°€ìƒí™˜ê²½ í™•ì¸ ë° ìƒì„±
            if [ ! -d ".venv" ]; then
                echo "ğŸ“¦ Python ê°€ìƒí™˜ê²½ì„ ìƒì„±í•©ë‹ˆë‹¤..."
                uv venv
            fi
            echo "ê°€ìƒí™˜ê²½ì„ ì‹¤í–‰"
            source .venv/bin/activate
            uv sync
            echo "ê°€ìƒí™˜ê²½ ë° ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ."

            echo "ğŸ”„ ê¸°ì¡´ ì„œë¹„ìŠ¤ë¥¼ ì¤‘ì§€í•©ë‹ˆë‹¤..."
            # í¬íŠ¸ ê¸°ë°˜ ì •ë¦¬ (ì•ˆì „í•¨)
            echo "í¬íŠ¸ 8000 ì •ë¦¬ ì¤‘..."
            lsof -ti:8000 | xargs -r kill -TERM 2>/dev/null || true
            sleep 3

            # systemctlë„ ì´ì œ ì•ˆì „í•˜ê²Œ ì‚¬ìš© ê°€ëŠ¥
            if sudo systemctl is-active --quiet fastapi-app; then
                sudo systemctl stop fastapi-app
                sleep 3
            fi

         
            # --- í™˜ê²½ ë³€ìˆ˜ (.env) íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸ ---
            echo "í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ì„ ìƒì„±/ì—…ë°ì´íŠ¸ ì¤‘..."
            # .env íŒŒì¼ ìƒì„± ë˜ëŠ” ë®ì–´ì“°ê¸°
            cat << EOF > "$PROJECT_DIR/.env"
            MONGODB_ATLAS_URI="${{ secrets.MONGODB_ATLAS_URI }}"
            JINA_API_KEY="${{ secrets.JINA_API_KEY }}"
            OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
            USE_ATLAS="${{ secrets.USE_ATLAS }}"
            GOOGLE_API_KEY="${{ secrets.GOOGLE_API_KEY }}"
            # í•„ìš”í•˜ë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì •ì˜í•˜ì„¸ìš”.
            EOF
            chmod 600 "$PROJECT_DIR/.env" # .env íŒŒì¼ ê¶Œí•œ ì„¤ì • (ì†Œìœ ìë§Œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥)
            echo "í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸ ë° ê¶Œí•œ ì„¤ì • ì™„ë£Œ."
            
            # --- systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸ ---
            echo "systemd ì„œë¹„ìŠ¤ íŒŒì¼ì„ ìƒì„±/ì—…ë°ì´íŠ¸ ì¤‘..."
            # systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„± (root ê¶Œí•œ í•„ìš”)
            sudo bash -c "cat << EOF > /etc/systemd/system/${SERVICE_NAME}
            [Unit]
            Description=FastAPI application service
            After=network.target

            [Service]
            User=${{ secrets.AI_SERVER_EC2_USERNAME }}
            WorkingDirectory=${PROJECT_DIR}
            ExecStart=${PROJECT_DIR}/.venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000
            Restart=always
            RestartSec=10
            EnvironmentFile=${PROJECT_DIR}/.env # .env íŒŒì¼ì—ì„œ í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ

            [Install]
            WantedBy=multi-user.target
            EOF"
            echo "systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸ ì™„ë£Œ."

            # --- systemd ì„œë¹„ìŠ¤ ì¬ë¡œë“œ, í™œì„±í™” ë° ì¬ì‹œì‘ ---
            echo "systemd ì„œë¹„ìŠ¤ ë°ëª¬ ì¬ë¡œë“œ, í™œì„±í™” ë° ì¬ì‹œì‘ ì¤‘..."
            sudo systemctl daemon-reload           # systemd ì„¤ì • ë‹¤ì‹œ ë¡œë“œ
            sudo systemctl enable ${SERVICE_NAME}  # ë¶€íŒ… ì‹œ ìë™ ì‹œì‘ í™œì„±í™”
            sudo systemctl restart ${SERVICE_NAME} # ì„œë¹„ìŠ¤ ì¬ì‹œì‘ (ìµœì‹  ì½”ë“œ ë° ì„¤ì • ì ìš©)
            echo "FastAPI systemd ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ëª…ë ¹ ì‹¤í–‰ ì™„ë£Œ."

            # --- ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ---
            sleep 5 # ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸°
            if systemctl is-active --quiet ${SERVICE_NAME}; then
                echo "FastAPI ì„œë²„ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
                echo "ë¡œê·¸ í™•ì¸: journalctl -u ${SERVICE_NAME} -f"
            else
                echo "FastAPI ì„œë²„ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”:"
                echo "sudo systemctl status ${SERVICE_NAME}"
                journalctl -u ${SERVICE_NAME} --no-pager -n 50 # ìµœê·¼ 50ì¤„ ë¡œê·¸ ì¶œë ¥
                exit 1 # ì„œë²„ ì‹œì‘ ì‹¤íŒ¨ ì‹œ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨
            fi

            # ë°°í¬ í™•ì¸
            echo "âœ… ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "ğŸ“ ì„œë²„ ì£¼ì†Œ: http://${{ secrets.AI_SERVER_EC2_HOST }}:8000"
            
            echo "ë°°í¬ ì™„ë£Œ: $(date)"
